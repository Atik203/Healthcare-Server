name: Auto Merge Pull Request

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'auto-generated') && github.event.pull_request.head.ref == 'dev'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait before merging
        run: |
          echo "Waiting 10 seconds to allow any checks to start..."
          sleep 10

      - name: Check PR status
        id: pr-status
        run: |
          # Get PR details
          pr_state=$(gh pr view ${{ github.event.pull_request.number }} --json state --jq '.state')
          mergeable=$(gh pr view ${{ github.event.pull_request.number }} --json mergeable --jq '.mergeable')

          echo "PR State: $pr_state"
          echo "Mergeable: $mergeable"

          if [ "$pr_state" = "OPEN" ] && [ "$mergeable" = "MERGEABLE" ]; then
            echo "can_merge=true" >> $GITHUB_OUTPUT
          else
            echo "can_merge=false" >> $GITHUB_OUTPUT
            echo "‚ùå PR cannot be merged. State: $pr_state, Mergeable: $mergeable"
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Add comment before merging
        if: steps.pr-status.outputs.can_merge == 'true'
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "ü§ñ **Auto-merging this pull request from dev to main...**
            
          ‚úÖ All checks passed - proceeding with automatic merge."
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Auto-merge PR
        if: steps.pr-status.outputs.can_merge == 'true'
        run: |
          echo "Auto-merging PR #${{ github.event.pull_request.number }}"

          # Merge the PR with squash and preserve the dev branch
          gh pr merge ${{ github.event.pull_request.number }} --squash
            
          echo "‚úÖ Successfully merged PR #${{ github.event.pull_request.number }}"
          echo "üìù Dev branch preserved for continued development"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Handle merge failure
        if: failure() || steps.pr-status.outputs.can_merge == 'false'
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "‚ö†Ô∏è **Auto-merge failed or cannot proceed**
            
          Possible reasons:
          - Merge conflicts need to be resolved
          - PR is not in a mergeable state
          - Required status checks are failing

          Please review and merge manually when ready."
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
